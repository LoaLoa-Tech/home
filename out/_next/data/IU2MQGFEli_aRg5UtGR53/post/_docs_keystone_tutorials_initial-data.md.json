{"pageProps":{"markdownPost":{"name":null,"url":null,"content":"<!--[meta]\nsection: tutorials\ntitle: Seeding data\norder: 3\n[meta]-->\n\n# Seeding data\n\nThis guide will show you how to create a `User` list and add initial data to it\nusing the `createItems` function. This process is also called `seeding`.\n\n> **Note:** In a previous chapter the code was split up over separate files, while this is preferred in a real code base, in this part everything is put in one file for clarity reasons.\n\n## List setup\n\n### Install packages\n\nThis chapter will use a different `User` schema than previous chapters and instead\nof a `Todo` list, there will be a `Post` list. It is best to start from a fresh\nproject and start from an empty database (delete data from previous chapters).\nAlso, make sure to have all of the following packages installed:\n\n```shell allowCopy=false showLanguage=false\nyarn add @keystonejs/keystone\nyarn add @keystonejs/adapter-mongoose\nyarn add @keystonejs/app-graphql\nyarn add @keystonejs/fields\nyarn add @keystonejs/app-admin-ui\nyarn add @keystonejs/auth-password\nyarn add @keystonejs/server-side-graphql-client\n```\n\n### Preparation\n\nFirst let's create a `User` list and add a `PasswordAuthStrategy`. The code in `index.js`:\n\n```javascript\nconst { Keystone } = require('@keystonejs/keystone');\nconst { PasswordAuthStrategy } = require('@keystonejs/auth-password');\nconst { Text, Checkbox, Password } = require('@keystonejs/fields');\nconst { GraphQLApp } = require('@keystonejs/app-graphql');\nconst { AdminUIApp } = require('@keystonejs/app-admin-ui');\nconst { MongooseAdapter } = require('@keystonejs/adapter-mongoose');\n\nconst keystone = new Keystone({\n  adapter: new MongooseAdapter(),\n});\n\nkeystone.createList('User', {\n  fields: {\n    name: { type: Text },\n    email: {\n      type: Text,\n      isUnique: true,\n    },\n    isAdmin: { type: Checkbox },\n    password: {\n      type: Password,\n    },\n  },\n});\n\nconst authStrategy = keystone.createAuthStrategy({\n  type: PasswordAuthStrategy,\n  list: 'User',\n});\n\nmodule.exports = {\n  keystone,\n  apps: [\n    new GraphQLApp(),\n    new AdminUIApp({ name: 'example-project', enableDefaultRoute: true, authStrategy }),\n  ],\n};\n```\n\n> **Tip:** A similar setup can be achieved by running the Keystone CLI `yarn create keystone-app` and selecting `Starter (Users + Authentication)`. This starter project has a `User` list, `PasswordAuthStrategy` and seeding of the database already configured. For now, we will proceed manually.\n\n## Creating items\n\nThe [`createItems`](https://www.keystonejs.com/keystonejs/server-side-graphql-client/#createitems) utility function requires a config object argument. It has the following `required` keys:\n\n- `keystone`: a Keystone instance\n- `listKey`: the Keystone list name\n- `items`: the array of objects to be created.\n\n```javascript\nconst { createItems } = require('@keystonejs/server-side-graphql-client');\n\ncreateItems({\n  keystone,\n  listKey: 'User',\n  items: [\n    { data: { name: 'John Duck', email: 'john@duck.com', password: 'dolphins' } },\n    { data: { name: 'Barry', email: 'bartduisters@bartduisters.com', password: 'dolphins' } },\n  ],\n});\n```\n\n**Note**: The format of the objects in the `items` array must align with the schema setup of the corresponding list name.\nAs an example in our schema, the `email` field has `isUnique:true` constraint, therefore it would not be possible for the above code to generate users with exactly same email.\n\nExample on how to `seed` the data upon database connection:\n\n```javascript\nconst { createItems } = require('@keystonejs/server-side-graphql-client');\n\nconst keystone = new Keystone({\n  adapter: new MongooseAdapter(),\n  onConnect: async keystone => {\n    await createItems({\n      keystone,\n      listKey: 'User',\n      items: [\n        { data: { name: 'John Duck', email: 'john@duck.com', password: 'dolphins' } },\n        { data: { name: 'Barry', email: 'bartduisters@bartduisters.com', password: 'dolphins' } },\n      ],\n    });\n  },\n});\n```\n\nStart the application and visit the Admin UI, two users are available on startup.\n\n> **Note:** In this example the same two users would be generated _every_ startup. Since email should be unique, this will cause a duplicate error to show up. To avoid this, clear the database before starting Keystone.\n\n## Relationships\n\nThe `items` in the `createItems` config object has the data type of GraphQL `[listKey]sCreateInput`. In our example, it's the `UsersCreateInput` which keystone created for us as part of the schema.\n\nConsequently, while seeding it's possible to create relationships between items using keystone `connect` [nested mutations](https://www.keystonejs.com/keystonejs/fields/src/types/relationship/#nested-mutations).\n\n### Single relationships\n\nAdd the `Relationship` field to the imports:\n\n```javascript\nconst { Text, Checkbox, Password, Relationship } = require('@keystonejs/fields');\n```\n\nCreate a list with a relationship to another list:\n\n```javascript\nkeystone.createList('Post', {\n  fields: {\n    title: {\n      type: Text,\n    },\n    author: {\n      type: Relationship,\n      ref: 'User',\n    },\n  },\n});\n```\n\nAs part of `connect` nested mutation, we need to provide the id of the item for which the single relationship is required. This implies that we need to extract the id of the previously created items.\n\nExample on how to seed an item with a relationship using `connect` nested mutation:\n\n```javascript\n await createItems({\n      keystone,\n      listKey: 'Post',\n      items: [\n         {data: {\n            title: 'Hello World',\n            author: {\n              // Extracting the id from `users` array\n              connect: { id: users.find(user => user.name === 'John Duck').id },\n            },\n           }\n        },\n      ],\n   },\n  })\n```\n\nThe full example:\n\n```javascript\nconst keystone = new Keystone({\n  adapter: new MongooseAdapter(),\n  onConnect: async keystone => {\n\n  // 1. Insert the user list first as it has no associated relationship.\n    const users = await createItems({\n      keystone,\n      listKey: 'User',\n      items: [\n        {data: { name: 'John Duck', email: 'john@duck.com', password: 'dolphins' } },\n        {data: { name: 'Barry', email: 'bartduisters@bartduisters.com', password: 'dolphins' } },\n      ],\n      returnFields: 'id, name',\n    });\n\n  // 2. Insert `Post` data, with the required relationships, via `connect` nested mutation.\n   await createItems({\n      keystone,\n      listKey: 'Post',\n      items: [\n         {data: {\n            title: 'Hello World',\n            author: {\n              // Extracting the id of the User list item\n              connect: { id: users.find(user => user.name === 'John Duck').id },\n            },\n           }\n        },\n      ],\n   },\n  });\n```\n\nClear the database, then start Keystone and visit the Admin UI to see that two users are generated and one post is generated. The post has an `author` named `John Duck`. In the database `author` will be the ID of the user with name John Duck\n\n### Many relationships\n\nA user can have many posts, add the `to-many` relationship field `posts` to the `User`:\n\n```javascript\nkeystone.createList('User', {\n  fields: {\n    name: { type: Text },\n    email: {\n      type: Text,\n      isUnique: true,\n    },\n    isAdmin: { type: Checkbox },\n    password: {\n      type: Password,\n    },\n    posts: {\n      type: Relationship,\n      ref: 'Post',\n      many: true,\n    },\n  },\n});\n```\n\nFollowing the same pattern as discussed above, we can easily establish a `to-many` relationship via `connect` [nested mutations](https://www.keystonejs.com/keystonejs/fields/src/types/relationship/#nested-mutations) approach. Instead of passing a single item id, we are required to pass an array of item ids.\n\n**Note**: We need to create posts first as it has no relationship, and we require the post ids to create `to-many` relationship with user items.\n\nTo associate all the posts where `title` contains the word `React`:\n\nIn action:\n\n```javascript\nconst keystone = new Keystone({\n  adapter: new MongooseAdapter(),\n  onConnect: async keystone => {\n    // 1. Create posts first as we need generated ids to establish relationship with user items.\n    const posts = await createItems({\n      keystone,\n      listKey: 'Post',\n      items: [\n        { data: { title: 'Hello Everyone' } },\n        { data: { title: 'Talking about React' } },\n        { data: { title: 'React is the Best' } },\n        { data: { title: 'Keystone Rocks' } },\n      ],\n      returnFields: 'id, title',\n    });\n\n    // 2. Insert User data with required relationship via nested mutations. `connect` requires an array of post item ids.\n    await createItems({\n      keystone,\n      listKey: 'User',\n      items: [\n        {\n          data: {\n            name: 'John Duck',\n            email: 'john@duck.com',\n            password: 'dolphins',\n            posts: {\n              // Filtering list of items where title contains the word `React`\n              connect: posts.filter(p => /\\bReact\\b/i.test(p.title)).map(i => ({ id: i.id })),\n            },\n          },\n        },\n        {\n          data: {\n            name: 'Barry',\n            email: 'bartduisters@bartduisters.com',\n            password: 'dolphins',\n            isAdmin: true,\n          },\n        },\n      ],\n    });\n  },\n});\n```\n\nClear the database, start the Keystone application and visit the Admin UI. Take a look at the user `John Duck`, he has two posts associated with him (there were two posts with the word `React` in the `title`).\n\nIf you want to explore other utility functions for `CRUD` operations, please refer to [server-side GraphQL client](https://www.keystonejs.com/keystonejs/server-side-graphql-client) API for more details.\n"}},"__N_SSG":true}