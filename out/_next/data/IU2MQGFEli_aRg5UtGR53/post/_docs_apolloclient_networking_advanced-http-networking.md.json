{"pageProps":{"markdownPost":{"name":null,"url":null,"content":"---\ntitle: Advanced HTTP networking\ndescription: Take full network control with Apollo Link\n---\n\nThe **Apollo Link** library gives you fine-grained control of HTTP requests that are sent by Apollo Client. You can also use it to replace Apollo Client's networking layer with something completely custom, such as a WebSocket transport or mocked server data.\n\nWhen using Apollo Link, you define network behavior as a collection of **link** objects that execute in sequence to control the flow of data. By default, Apollo Client uses Apollo Link's `HttpLink` to send GraphQL queries over HTTP.\n\nApollo Link includes installable, premade links that support a variety of use cases. You can also create your own custom links.\n\n## Customizing request logic\n\nThe following example demonstrates adding a custom link to Apollo Client. This link adds an `Authorization` header to every HTTP request before the `HttpLink` sends it:\n\n```js\nimport { ApolloClient, HttpLink, ApolloLink, InMemoryCache, concat } from '@apollo/client';\n\nconst httpLink = new HttpLink({ uri: '/graphql' });\n\nconst authMiddleware = new ApolloLink((operation, forward) => {\n  // add the authorization to the headers\n  operation.setContext({\n    headers: {\n      authorization: localStorage.getItem('token') || null,\n    }\n  });\n\n  return forward(operation);\n})\n\nconst client = new ApolloClient({\n  cache: new InMemoryCache(),\n  link: concat(authMiddleware, httpLink),\n});\n```\n\nThis next example demonstrates providing multiple custom links in an array:\n\n```js\nimport { ApolloClient, HttpLink, ApolloLink, InMemoryCache, from } from '@apollo/client';\n\nconst httpLink = new HttpLink({ uri: '/graphql' });\n\nconst authMiddleware = new ApolloLink((operation, forward) => {\n  // add the authorization to the headers\n  operation.setContext(({ headers = {} }) => ({\n    headers: {\n      ...headers,\n      authorization: localStorage.getItem('token') || null,\n    }\n  }));\n\n  return forward(operation);\n})\n\nconst activityMiddleware = new ApolloLink((operation, forward) => {\n  // add the recent-activity custom header to the headers\n  operation.setContext(({ headers = {} }) => ({\n    headers: {\n      ...headers,\n      'recent-activity': localStorage.getItem('lastOnlineTime') || null,\n    }\n  }));\n\n  return forward(operation);\n})\n\nconst client = new ApolloClient({\n  cache: new InMemoryCache(),\n  link: from([\n    authMiddleware,\n    activityMiddleware,\n    httpLink\n  ]),\n});\n```\n\nIn the example above, the `authMiddleware` link sets each request's `Authorization` header, and the `activityMiddleware` then sets each request's `Recent-Activity` header. Finally, the `HttpLink` sends the modified request.\n\n## Customizing response logic\n\nYou can use Apollo Link to customize Apollo Client's behavior whenever it receives a response from a request.\n\nThe following example demonstrates using [`@apollo/client/link/error`](../api/link/apollo-link-error/) to handle network errors that are included in a response:\n\n```js\nimport { ApolloClient, InMemoryCache, HttpLink } from '@apollo/client';\nimport { onError } from '@apollo/client/link/error';\n\nimport { logout } from './logout';\n\nconst httpLink = new HttpLink({ uri: '/graphql' });\n\nconst logoutLink = onError(({ networkError }) => {\n  if (networkError.statusCode === 401) logout();\n})\n\nconst client = new ApolloClient({\n  cache: new InMemoryCache(),\n  link: logoutLink.concat(httpLink),\n});\n```\n\nIn this example, the user is logged out of the application if the server returns a `401` code (unauthorized).\n\n### Modifying response data\n\nYou can create a custom link that adds, edits, or removes fields from `response.data`. To do so, you call `map` on the result of the link's `forward(operation)` call. In the `map` function, make any desired changes to `response.data` and then return it:\n\n```js\nimport { ApolloClient, InMemoryCache, HttpLink, ApolloLink } from '@apollo/client';\n\nconst httpLink = new HttpLink({ uri: '/graphql' });\n\nconst addDateLink = new ApolloLink((operation, forward) => {\n  return forward(operation).map(response => {\n    response.data.date = new Date();\n    return response;\n  });\n});\n\nconst client = new ApolloClient({\n  cache: new InMemoryCache(),\n  link: addDateLink.concat(httpLink),\n});\n```\n\nIn the above example, `addDateLink` adds a `date` field to the top level of each response.\n\nNote that `forward(operation).map(func)` _doesn't_ support asynchronous execution of the `func` mapping function. If you need to make asynchronous modifications, use the `asyncMap` function from `@apollo/client/utilities`, like so:\n\n```js\nimport {\n  ApolloClient,\n  InMemoryCache,\n  HttpLink,\n  ApolloLink\n} from \"@apollo/client\";\nimport { asyncMap } from \"@apollo/client/utilities\";\n\nimport { usdToEur } from './currency';\n\nconst httpLink = new HttpLink({ uri: '/graphql' });\n\nconst usdToEurLink = new ApolloLink((operation, forward) => {\n  return asyncMap(forward(operation), async (response) => {\n    let data = response.data;\n    if (data.price && data.currency === \"USD\") {\n      data.price = await usdToEur(data.price);\n      data.currency = \"EUR\";\n    }\n    return response;\n  });\n});\n\nconst client = new ApolloClient({\n  cache: new InMemoryCache(),\n  link: usdToEurLink.concat(httpLink)\n});\n```\n\nIn the example above, `usdToEurLink` uses `asyncMap` to convert the response object's `price` field from USD to EUR using an external API.\n\nWhile this technique can be useful for modifying _existing_ fields (or adding additional objects to lists within `data`), adding _new_ fields to `data` won't work in most cases, because the operation document cannot be safely modified within the `ApolloLink` request pipeline.\n\n## The `HttpLink` object\n\nApollo Client uses `HttpLink` to send GraphQL operations to a server over HTTP. The link supports both POST and GET requests, and it can modify HTTP options on a per-query basis. This comes in handy when implementing authentication, persisted queries, dynamic URIs, and other granular updates.\n\n> If your client doesn't have complex HTTP requirements, you probably don't need to create a custom instance of `HttpLink`. For details, see [Basic HTTP networking](./basic-http-networking/).\n\n### Usage\n\n```js\nimport { HttpLink } from \"@apollo/client\";\n\nconst link = new HttpLink({ uri: \"/graphql\" });\n```\n\n### Constructor options\n\nThe `HttpLink` constructor accepts the following options:\n\n| Options | Description |\n| - | - |\n| `uri` | A string endpoint or function that resolves to the GraphQL server you want to execute operations against. (default: `/graphql`)|\n| `includeExtensions` | If `true`, you can pass an `extensions` field to your GraphQL server. (default: `false`) |\n| `fetch` | A `fetch`-compatible API for making a request. See [Providing a `fetch` replacement for certain environments](#providing-a-fetch-replacement-for-certain-environments). |\n| `headers` | An object containing header names and values to include in each request. |\n| `credentials` | A string representing the credentials policy to use for the `fetch` call. (valid values: `omit`, `include`, `same-origin`) |\n| `fetchOptions` | Include this to override the values of certain options that are provided to the `fetch` call. |\n| `useGETForQueries` | If `true`, `HttpLink` uses `GET` requests instead of `POST` requests to execute query operations (but not mutation operations). (default: `false`) |\n\n#### Providing a `fetch` replacement for certain environments\n\n`HttpLink` requires that `fetch` is present in your runtime environment. This is the case for React Native and most modern browsers. If you're targeting an environment that _doesn't_ include `fetch` (such as older browsers or the server), you need to pass your own `fetch` to `HttpLink` via its [constructor options](#constructor-options). We recommend using [`cross-fetch`](https://www.npmjs.com/package/cross-fetch) for older browsers and Node.\n\n### Overriding options\n\nYou can override most `HttpLink` constructor options on an operation-by-operation basis by modifying the `context` object for the operation. For example, you can set the `headers` field on the `context` to pass custom headers for a particular operation. The `context` also supports the `credentials` field for defining credentials policy, `uri` for changing the endpoint dynamically, and `fetchOptions` to allow generic fetch overrides (i.e., `method: \"GET\"`).\n\nNote that if you set `fetchOptions.method` to `GET`, `HttpLink` follows the [standard GraphQL HTTP GET encoding](http://graphql.org/learn/serving-over-http/#get-request). The query, variables, operation name, and extensions are passed as query parameters instead of in the HTTP request body (because there isn't one). If you to continue to send mutations as non-idempotent `POST` requests, set the top-level `useGETForQueries` option to `true` instead of setting `fetchOptions.method` to `GET`.\n\n`HttpLink` also attaches the response from the `fetch` operation to the context as `response`, so you can access it in another link.\n\nContext options:\n\n| Option | Description |\n| - | - |\n| `headers` | An object containing header names and values to include in each request. |\n| `credentials` | A string representing the credentials policy to use for the `fetch` call. (valid values: `omit`, `include`, `same-origin`) |\n| `uri` | A string endpoint or function that resolves to the GraphQL server you want to execute operations against. |\n| `fetchOptions` | Any overrides of the fetch options argument to pass to the `fetch` call. |\n| `response` | The raw response from the `fetch` request after it is made. |\n| `http` | An object that lets you control fine-grained aspects of `HttpLink` itself, such as persisted queries (see below). |\n\nThe following example shows how to use the `context` to pass a special header for a single query:\n\n```js\nimport { ApolloClient, InMemoryCache } from \"@apollo/client\";\n\nconst client = new ApolloClient({\n  cache: new InMemoryCache(),\n  uri: \"/graphql\"\n});\n\nclient.query({\n  query: MY_QUERY,\n  context: {\n    // example of setting the headers with context per operation\n    headers: {\n      special: \"Special header value\"\n    }\n  }\n});\n```\n\n### Custom fetching\n\n`HttpLink`'s `fetch` option can be used to wire in custom networking. This is useful if you want to modify the request based on calculated headers, or calculate the URI based on an operation. For example:\n\n**Custom auth:**\n\n```js\nconst customFetch = (uri, options) => {\n  const { header } = Hawk.client.header(\n    \"http://example.com:8000/resource/1?b=1&a=2\",\n    \"POST\",\n    { credentials: credentials, ext: \"some-app-data\" }\n  );\n  options.headers.Authorization = header;\n  return fetch(uri, options);\n};\n\nconst link = new HttpLink({ fetch: customFetch });\n```\n\n**Dynamic URI:**\n\n```js\nconst customFetch = (uri, options) => {\n  const { operationName } = JSON.parse(options.body);\n  return fetch(`${uri}/graph/graphql?opname=${operationName}`, options);\n};\n\nconst link = new HttpLink({ fetch: customFetch });\n```\n\n## Using other links\n\nApollo Link includes many links for specialized use cases, such as the `WebSocketLink` for communicating over WebSocket and the `BatchHttpLink` for combining multiple GraphQL operations in a single HTTP request.\n\nTo learn more about what's available, see the [Apollo Link API documentation](../api/link/introduction/).\n"}},"__N_SSG":true}